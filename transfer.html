<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMART DENTISTRY - Data Transfer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#00d4ff;--muted:#f8f9fb;--dark:#2c3e50;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Poppins",sans-serif;background:var(--muted);color:#222}
    .sidebar{position:fixed;top:0;left:0;width:220px;height:100vh;background:var(--dark);color:#fff;display:flex;flex-direction:column;justify-content:space-between}
    .sidebar .logo{padding:20px;text-align:center;font-weight:700;border-bottom:1px solid rgba(255,255,255,0.06)}
    .sidebar .logo i{color:var(--accent);font-size:28px}
    .sidebar ul{list-style:none;padding:0 0 20px 0}
    .sidebar li{padding:12px 20px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:0.2s;color:#fff}
    .sidebar li:hover,.sidebar li.active{background:var(--accent);color:#000;border-radius:0 30px 30px 0}
    .sidebar .bottom{padding:18px;font-size:14px}
    .main{margin-left:220px;padding:24px}
    h1{color:var(--accent);margin-bottom:16px}
    .section{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:14px}
    h3{margin:0 0 10px 0;color:#666;font-size:14px}
    .controls{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px}
    textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:12px;resize:vertical}
    .note{font-size:12px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="logo"><i class="fa-solid fa-tooth"></i><br/>SMART<br/>DENTISTRY</div>
      <ul>
        <li onclick="location.href='dashboard.html'"><i class="fa-solid fa-gauge-high"></i> Dashboard</li>
        <li onclick="location.href='patients.html'"><i class="fa-solid fa-user"></i> Patients</li>
        <li onclick="location.href='patients.html#appointments'"><i class="fa-solid fa-calendar-days"></i> Appointments</li>
        <li onclick="location.href='patients.html'"><i class="fa-solid fa-clipboard-list"></i> Records</li>
        <li onclick="location.href='patients.html'"><i class="fa-solid fa-money-bill-trend-up"></i> Finance</li>
        <li class="active"><i class="fa-solid fa-arrows-left-right"></i> Data Transfer</li>
        <li onclick="location.href='backup.html'"><i class="fa-solid fa-database"></i> Data Backup</li>
        <li onclick="location.href='reports.html'"><i class="fa-solid fa-file-lines"></i> Reports</li>
      </ul>
    </div>
    <div class="bottom">‚öôÔ∏è Settings &nbsp; ‚Ä¢ &nbsp; üö™ Logout</div>
  </aside>

  <main class="main">
    <h1>Data Transfer</h1>

    <div class="section">
      <h3>Generate Transfer Code</h3>
      <p style="font-size:13px;margin-bottom:8px">Create a compact code to transfer your clinic data to another device.</p>
      <div class="controls">
        <button class="btn" id="generateBtn"><i class="fa-solid fa-refresh"></i> Generate Code</button>
        <button class="btn" id="copyBtn"><i class="fa-solid fa-copy"></i> Copy</button>
      </div>
      <textarea id="transferCode" rows="5" placeholder="Transfer code will appear here" readonly></textarea>
      <div class="note">‚úì This code contains all your patients, appointments, and records in a compact Base64 format.</div>
    </div>

    <div class="section">
      <h3>Restore from Transfer Code</h3>
      <p style="font-size:13px;margin-bottom:8px">Paste a transfer code from another device to restore data.</p>
      <textarea id="pasteCode" rows="5" placeholder="Paste transfer code here"></textarea>
      <div class="controls" style="margin-top:8px">
        <button class="btn" id="restoreBtn"><i class="fa-solid fa-upload"></i> Restore</button>
        <button style="background:#fff;border:1px solid #ddd;color:#000;padding:8px 12px;border-radius:6px;cursor:pointer" id="clearBtn">Clear</button>
      </div>
      <div class="note">‚ö† This will replace your current clinic data. Make a backup first!</div>
    </div>
  </main>

  <script>
    const KNOWN_KEYS=['activePatients','inactivePatients','todayAppointments','settings','appointments','expenses'];

    function getBackupData(){
      const data = {};
      KNOWN_KEYS.forEach(k=>{
        try{ data[k]=JSON.parse(localStorage.getItem(k)); }catch(e){ data[k]=localStorage.getItem(k); }
      });
      const other = {};
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(!KNOWN_KEYS.includes(key) && key !== 'backups' && key !== 'transfers') other[key]=localStorage.getItem(key);
      }
      data._others = other;
      data._meta = { ts: new Date().toISOString(), device: navigator.userAgent };
      return data;
    }

    function encodeTransfer(obj){
      return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
    }

    function decodeTransfer(code){
      try{
        return JSON.parse(decodeURIComponent(escape(atob(code.trim()))));
      }catch(e){
        return null;
      }
    }

    function restoreData(obj){
      Object.keys(obj).forEach(k=>{
        if(k.startsWith('_')) return;
        try{
          localStorage.setItem(k, JSON.stringify(obj[k]));
        }catch(e){
          localStorage.setItem(k, String(obj[k]));
        }
      });
    }

    document.getElementById('generateBtn').addEventListener('click', ()=>{
      const data = getBackupData();
      const code = encodeTransfer(data);
      document.getElementById('transferCode').value = code;
    });

    document.getElementById('copyBtn').addEventListener('click', ()=>{
      const val = document.getElementById('transferCode').value;
      if(!val) return alert('Generate a code first.');
      navigator.clipboard?.writeText(val).then(()=>alert('Copied to clipboard!'), ()=>alert('Copy manually'));
    });

    document.getElementById('restoreBtn').addEventListener('click', ()=>{
      const code = document.getElementById('pasteCode').value.trim();
      if(!code) return alert('Paste a transfer code first.');
      const obj = decodeTransfer(code);
      if(!obj) return alert('Invalid transfer code.');
      if(!confirm('Restore this data? This will replace current records. Continue?')) return;
      restoreData(obj);
      alert('Data restored! Reloading...');
      location.reload();
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('pasteCode').value='';
    });
  </script>
</body>
</html>