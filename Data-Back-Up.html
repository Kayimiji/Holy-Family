<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMART DENTISTRY - Data Backup</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#00d4ff;--muted:#f8f9fb;--dark:#2c3e50;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Poppins",sans-serif;background:var(--muted);color:#222}
    /* Sidebar Background */
.sidebar {
    background-color: #2c3e50; /* same dark blue as second image */
    width: 260px;
    height: 100vh;
    padding: 20px 15px;
    position: fixed;
}

/* Logo area fix */
.sidebar .logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
}
 .sidebar-logo {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  margin-right: -5px;
  margin-top: -45px;
  margin-left: -20px;
  Object-fit: cover;
  }

.sidebar .logo-text {
    color: #ffffff;
    font-weight: 700;
    font-size: 18px;
    text-align: center;
}

/* Remove blue link style */
.sidebar a {
    text-decoration: none !important;
    color: #ffffff;            /* light gray text */
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
}

/* Fix icons color */
.sidebar a i,
.sidebar a svg {
    color: #ffffff !important;
}

/* Hover effect */
.sidebar a:hover {
    color: #ffffff;            /* mint green like second image */
}

.sidebar a:hover i,
.sidebar a:hover svg {
    color: #ffffff !important;
}

/* "Settings" and bottom section fix */
.sidebar-bottom {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.2);
}

.sidebar-bottom a {
    padding: 10px 0;

}
    .sidebar{position:fixed;top:0;left:0;width:200px;height:100%;background:var(--dark);color:#fff;padding:20px;display:flex;flex-direction:column;justify-content:space-between}
    .logo{font-size:18px;font-weight:700;text-align:center;margin-bottom:30px;line-height:1.2}
    .logo i{font-size:36px;margin-bottom:8px;color:var(--accent)}         
    .main{margin-left:220px;padding:24px}
    h1{color:var(--accent);margin-bottom:12px}
    .controls{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#000;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .secondary{background:#fff;border:1px solid #ddd;padding:8px 12px;border-radius:8px;cursor:pointer}
    .list{margin-top:16px;background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.06)}
    .list h4{margin:0 0 8px 0;color:#666}
    .backup-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:1px dashed #eee;font-size:13px}
    input[type="file"]{display:none}
    .note{font-size:13px;color:#666;margin-top:10px}
  </style>
</head>
<body>
  <aside class="sidebar">
    <div>
      <div class="logo"><i class="fa-solid fa-tooth"></i><br/>SMART<br/>DENTISTRY</div>
      <ul>
        <ul class="sidebar-menu">
                <li><a href="admin.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="My-Clinic.html"><i class="fas fa-tooth"></i> My Clinic</a></li>
                <li><a href="appointment-history.html"><i class="fas fa-calendar-alt"></i> <span> Appointment History</a></li>
                <li><a href="patients.html"><i class="fas fa-users"></i> <span>Patients</span></a></li>
                <li><a href="Finance.html"><i class="fas fa-dollar-sign"></i> Finance</a></li>
                <li><a href="Data-Back-Up.html"><i class="fa solid fa-database"></i> <span> Data BackUp</a></li>
                <li><a href="Reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                <li><a href="Tutorial.html"><i class="fas fa-sticky-note"></i> Tutorial</a></li>
                <li><a href="landingpage.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
            <!-- Add Return to Home menu at the bottom -->
            <div style="position: absolute; bottom: 20px; width: 13%;">
                <div style="position: absolute; bottom: 20px; width: 100%;">
                    <ul class="sidebar-menu settings-menu">
                        <li><a href="Admin settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                    <ul class="sidebar-menu return-home-menu">
                        <li><a href="landingpage.html" class="logout-btn"><i class="fas fa-arrow-left"></i> Return to Home</a></li>
                    </ul>
                </div>
            </div>
    
    </div>

  </aside>

  <main class="main">
    <h1>Data Backup</h1>

    <div class="controls">
      <button class="btn" id="downloadJsonBtn"><i class="fa-regular fa-file-export"></i> Download JSON Backup</button>
      <button class="btn" id="downloadCsvBtn"><i class="fa-regular fa-file-csv"></i> Export Patients CSV</button>

      <label class="secondary" id="uploadLabel" title="Upload backup JSON">
        <input type="file" id="fileInput" accept="application/json">
        <i class="fa-regular fa-file-import"></i> Upload & Restore
      </label>

      <button class="btn" id="saveSnapshotBtn">Save Snapshot</button>
      <button class="secondary" id="clearDataBtn">Clear App Data</button>
    </div>

    <!-- Data Transfer UI -->
    <div id="transfer" style="margin-top:18px">
      <h3 style="margin:6px 0 8px 0;color:#666">Data Transfer</h3>
      <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
        <div style="margin-bottom:8px">
          <strong>Generate transfer code</strong>
          <div style="font-size:13px;color:#666">Create a compact code you can copy/paste to another device to restore data.</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" id="generateTransferBtn">Generate Transfer Code</button>
          <button class="secondary" id="copyTransferBtn">Copy</button>
        </div>
        <textarea id="transferCode" rows="4" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:monospace" placeholder="Transfer code will appear here" readonly></textarea>

        <div style="height:12px"></div>

        <div style="margin-top:10px;margin-bottom:6px"><strong>Restore from transfer code</strong></div>
        <textarea id="pasteTransfer" rows="4" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:monospace" placeholder="Paste transfer code here to restore"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="restoreTransferBtn">Restore from Code</button>
          <button class="secondary" id="clearTransferBtn">Clear</button>
        </div>
      </div>
    </div>

    <div class="note">Backups saved here are stored in your browser's localStorage under key "backups". Use Download to get a file you can keep externally.</div>

    <div class="list" id="backupsList">
      <h4>Saved Snapshots</h4>
      <div id="snapshotsContainer">
        <!-- snapshots listed here -->
      </div>
    </div>
  </main>

  <script>
    // Known application localStorage keys to include in backups
    const KNOWN_KEYS = ['activePatients','inactivePatients','todayAppointments','settings','appointments'];

    // helpers
    function getBackupData(){
      const data = {};
      // include known keys; include any other localStorage entries if desired
      KNOWN_KEYS.forEach(k=>{
        try{ data[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ data[k] = localStorage.getItem(k); }
      });
      // also include everything else under their raw string form
      const other = {};
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(!KNOWN_KEYS.includes(key) && key !== 'backups') other[key] = localStorage.getItem(key);
      }
      data._others = other;
      data._meta = { exportedAt: new Date().toISOString(), origin: location.hostname };
      return data;
    }

    function downloadJSON(filename='smartdentistry-backup.json'){
      const data = getBackupData();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function downloadPatientsCSV(filename='patients.csv'){
      // combine active + inactive patients if present
      const act = JSON.parse(localStorage.getItem('activePatients')||'[]');
      const inact = JSON.parse(localStorage.getItem('inactivePatients')||'[]');
      const rows = [['source','name','phone','email','address','registered','lastVisit','lastTreatment']];
      function pushRows(list,src){
        list.forEach(p=>{
          rows.push([src, (p.name||''), (p.phone||''), (p.email||''), (p.address||''), (p.registered||''), (p.lastVisit||''), (p.lastTreatment||'')]);
        });
      }
      pushRows(act,'active');
      pushRows(inact,'inactive');
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function saveSnapshot(){
      const backups = JSON.parse(localStorage.getItem('backups')||'[]');
      const snapshot = { id: Date.now(), meta:{ts:new Date().toISOString()}, data: getBackupData() };
      backups.unshift(snapshot); // newest first
      // limit kept snapshots to 20
      localStorage.setItem('backups', JSON.stringify(backups.slice(0,20)));
      renderSnapshots();
      alert('Snapshot saved to localStorage (backups).');
    }

    function renderSnapshots(){
      const container = document.getElementById('snapshotsContainer');
      const backups = JSON.parse(localStorage.getItem('backups')||'[]');
      container.innerHTML = '';
      if(backups.length === 0){ container.innerHTML = '<div style="padding:8px;color:#666">No snapshots saved.</div>'; return; }
      backups.forEach(b=>{
        const div = document.createElement('div');
        div.className = 'backup-item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${new Date(b.meta.ts).toLocaleString()}</strong><div style="font-size:12px;color:#666">id: ${b.id}</div>`;
        const right = document.createElement('div');
        right.style.display='flex'; right.style.gap='8px';
        const restoreBtn = document.createElement('button');
        restoreBtn.className='secondary'; restoreBtn.textContent='Restore';
        restoreBtn.onclick = ()=>{ if(confirm('Restore this snapshot? This will overwrite current app data in localStorage.')) restoreBackupObject(b.data); };

        const downloadBtn = document.createElement('button');
        downloadBtn.className='btn'; downloadBtn.textContent='Download';
        downloadBtn.onclick = ()=> {
          const blob = new Blob([JSON.stringify(b.data,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = `snapshot-${b.id}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        };

        const delBtn = document.createElement('button');
        delBtn.className='secondary'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> { if(confirm('Delete this snapshot?')) { deleteSnapshot(b.id); } };

        right.appendChild(restoreBtn); right.appendChild(downloadBtn); right.appendChild(delBtn);
        div.appendChild(left); div.appendChild(right);
        container.appendChild(div);
      });
    }

    function deleteSnapshot(id){
      const backups = JSON.parse(localStorage.getItem('backups')||'[]').filter(b=>b.id!==id);
      localStorage.setItem('backups', JSON.stringify(backups));
      renderSnapshots();
    }

    function restoreBackupObject(data){
      // write known keys back
      Object.keys(data).forEach(k=>{
        if(k === '_meta') return;
        try{
          localStorage.setItem(k, JSON.stringify(data[k]));
        }catch(e){
          // fallback if already string
          localStorage.setItem(k, String(data[k]));
        }
      });
      alert('Backup restored into localStorage. Reloading page...');
      location.reload();
    }

    // file import
    document.getElementById('fileInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(!confirm('Restore data from uploaded backup? This will overwrite current app data.')) return;
          restoreBackupObject(parsed);
        }catch(err){
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      // reset input so same file can be selected again later
      e.target.value = '';
    });

    // clear app data (dangerous)
    function clearAppData(){
      if(!confirm('Clear application data from localStorage? This cannot be undone (except via backup).')) return;
      // keep backups array (snapshots) unless user chooses to remove
      const preserved = localStorage.getItem('backups');
      localStorage.clear();
      if(preserved) localStorage.setItem('backups', preserved);
      alert('Application data cleared. Reloading page...');
      location.reload();
    }

    // Transfer code helpers (Base64-safe for UTF-8)
    function encodeForTransfer(obj){
      const json = JSON.stringify(obj);
      // encode utf-8 safely
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeFromTransfer(code){
      try{
        const json = decodeURIComponent(escape(atob(code)));
        return JSON.parse(json);
      }catch(e){
        return null;
      }
    }

    document.getElementById('generateTransferBtn').addEventListener('click', ()=>{
      const data = getBackupData();
      const code = encodeForTransfer(data);
      document.getElementById('transferCode').value = code;
    });

    document.getElementById('copyTransferBtn').addEventListener('click', ()=>{
      const val = document.getElementById('transferCode').value;
      if(!val) return alert('No transfer code to copy. Generate one first.');
      navigator.clipboard?.writeText(val).then(()=>alert('Transfer code copied to clipboard.'), ()=>alert('Copy failed. Select and copy manually.'));
    });

    document.getElementById('restoreTransferBtn').addEventListener('click', ()=>{
      const code = document.getElementById('pasteTransfer').value.trim();
      if(!code) return alert('Paste a transfer code first.');
      const parsed = decodeFromTransfer(code);
      if(!parsed) return alert('Invalid transfer code.');
      if(!confirm('Restore data from transfer code? This will overwrite current app data in localStorage.')) return;
      restoreBackupObject(parsed);
    });

    document.getElementById('clearTransferBtn').addEventListener('click', ()=>{ document.getElementById('pasteTransfer').value=''; document.getElementById('transferCode').value=''; });

    // wire buttons
    document.getElementById('downloadJsonBtn').addEventListener('click', ()=>downloadJSON());
    document.getElementById('downloadCsvBtn').addEventListener('click', ()=>downloadPatientsCSV());
    document.getElementById('saveSnapshotBtn').addEventListener('click', saveSnapshot);
    document.getElementById('clearDataBtn').addEventListener('click', clearAppData);
    // generate a preview transfer code if user lands on #transfer
    if(location.hash === '#transfer') setTimeout(()=>document.getElementById('generateTransferBtn').click(), 300);
  </script>
</body>
</html>