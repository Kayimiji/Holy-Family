<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SMART DENTISTRY - Data Backup</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f5f7fa;
      --sidebar-bg: #2c3e50;
      --sidebar-text: rgba(255, 255, 255, 0.9);
      --sidebar-active: #00bfff;
      --card-bg: #ffffff;
      --text-color: #2c3e50;
      --text-muted: #7a8ba9;
      --border-color: #e1e5eb;
      --hover-bg: #f0f4f8;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --sidebar-bg: #151e25;
      --sidebar-text: rgba(255, 255, 255, 0.85);
      --sidebar-active: #00bfff;
      --card-bg: #2d2d2d;
      --text-color: #e0e0e0;
      --text-muted: #aaa;
      --border-color: #444;
      --hover-bg: #333;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease;
    }
    .dashboard {
      display: flex;
      height: 100vh;
      min-height: 100vh;
      overflow: hidden;
      color: var(--text-color);
    }
    .sidebar {
      background-color: var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 20px 0;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s ease;
      width: 220px;
      overflow-y: auto;
      position: relative;
      min-width: 220px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 20px;
      margin-bottom: 30px;
    }
    .logo-container {
      position: relative;
    }
    .sidebar-logo {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-right: -5px;
      margin-top: -45px;
      margin-left: -20px;
      object-fit: cover;
    }
    .sidebar-title h2 {
      color: var(--sidebar-active);
      margin: 0;
      font-size: 18px;
      line-height: 1;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }
    .sidebar-title p {
      color: var(--sidebar-text);
      font-size: 12px;
      margin-top: 10px;
      margin-left: -40px;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      white-space: normal;
    }
    .holy-family {
      color: #00bbff;
      font-weight: bold;
    }
    .dental-clinic {
      color: #00bbff;
      font-weight: bold;
    }
    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .sidebar-menu li {
      margin-bottom: 5px;
    }
    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--sidebar-text);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background-color: rgba(0, 191, 255, 0.2);
      color: white;
      border-left: 3px solid var(--sidebar-active);
      padding-left: 17px;
    }
    .sidebar-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    .return-home-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .return-home-menu li {
      margin-bottom: 5px;
    }
    .return-home-menu a {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      color: var(--sidebar-text);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .return-home-menu a:hover, .return-home-menu a.active {
      background-color: rgba(0, 191, 255, 0.2);
      color: white;
      border-left: 3px solid var(--sidebar-active);
      padding-left: 17px;
    }
    .return-home-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }
    .settings-menu a:hover, .return-home-menu a:hover {
      background-color: rgba(0, 191, 255, 0.2);
      color: white;
      border-left: 3px solid var(--sidebar-active);
      display: block;
      width: 100%;
      padding-right: 25px;
    }
    .main {
      flex: 1;
      margin-left: 220px;
      padding: 24px;
      background: var(--bg-color);
      min-height: 100vh;
      transition: background-color 0.3s ease;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h1 {
      color: var(--sidebar-active);
      margin: 0;
    }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .theme-toggle-label {
      font-size: 14px;
      color: var(--text-color);
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #00bfff;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    /* Sidebar Background */
.sidebar {
    background-color: #2c3e50; /* same dark blue as second image */
    width: 260px;
    height: 100vh;
    padding: 20px 15px;
    position: fixed;
}

/* Logo area fix */
.sidebar .logo {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 30px;
}
 .sidebar-logo {
  width: 90px;
  height: 90px;
  border-radius: 50%;
  margin-right: -5px;
  margin-top: -45px;
  margin-left: -20px;
  Object-fit: cover;
  }

.sidebar .logo-text {
    color: #ffffff;
    font-weight: 700;
    font-size: 18px;
    text-align: center;
}

/* Remove blue link style */
.sidebar a {
    text-decoration: none !important;
    color: #ffffff;            /* light gray text */
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 0;
}

/* Fix icons color */
.sidebar a i,
.sidebar a svg {
    color: #ffffff !important;
}

/* Hover effect */
.sidebar a:hover {
    color: #ffffff;            /* mint green like second image */
}

.sidebar a:hover i,
.sidebar a:hover svg {
    color: #ffffff !important;
}

/* "Settings" and bottom section fix */
.sidebar-bottom {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.2);
}

.sidebar-bottom a {
    padding: 10px 0;

}
    /* ...existing code for .btn, .controls, .list, etc... */
  </style>
</head>
<body>
<div class="dashboard">
  <!-- Sidebar Navigation (copied from admin.html) -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="logo-container">
        <img src="logo.png" alt="Holy Family Dental Clinic Logo" class="sidebar-logo">
        <div class="logo-glow"></div>
      </div>
      <div class="sidebar-title">
        <h2>
          <span class="holy-family">SMART</span><br>
          <span class="dental-clinic">DENTISTRY</span>
        </h2>
      </div>
    </div>
    <ul class="sidebar-menu">
      <li><a href="admin.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="My-Clinic.html"><i class="fas fa-tooth"></i> My Clinic</a></li>
      <li><a href="appointment-history.html"><i class="fas fa-calendar-alt"></i> Appointment History</a></li>
      <li><a href="patients.html"><i class="fas fa-users"></i> Patients</a></li>
      <li><a href="Finance.html"><i class="fas fa-dollar-sign"></i> Finance</a></li>
      <li><a href="Data-Back-Up.html" class="active"><i class="fa solid fa-database"></i> Data BackUp</a></li>
      <li><a href="Reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
      <li><a href="Tutorial.html"><i class="fas fa-sticky-note"></i> Tutorial</a></li>
      <li><a href="landingpage.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
    <!-- Add Return to Home menu at the bottom -->
    <div style="position: absolute; bottom: 20px; width: 100%;">
      <ul class="sidebar-menu settings-menu">
        <li><a href="Admin settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      </ul>
      <ul class="sidebar-menu return-home-menu">
        <li><a href="landingpage.html" class="logout-btn"><i class="fas fa-arrow-left"></i> Return to Home</a></li>
      </ul>
    </div>
  </div>

  <main class="main">
    <div class="header">
      <h1>Data Backup</h1>
      <div class="theme-toggle">
        <span class="theme-toggle-label">Dark Mode</span>
        <label class="switch">
          <input type="checkbox" id="themeToggle">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="controls">
      <button class="btn" id="downloadJsonBtn"><i class="fa-regular fa-file-export"></i> Download JSON Backup</button>
      <button class="btn" id="downloadCsvBtn"><i class="fa-regular fa-file-csv"></i> Export Patients CSV</button>

      <label class="secondary" id="uploadLabel" title="Upload backup JSON">
        <input type="file" id="fileInput" accept="application/json">
        <i class="fa-regular fa-file-import"></i> Upload & Restore
      </label>

      <button class="btn" id="saveSnapshotBtn">Save Snapshot</button>
      <button class="secondary" id="clearDataBtn">Clear App Data</button>
    </div>

    <!-- Data Transfer UI -->
    <div id="transfer" style="margin-top:18px">
      <h3 style="margin:6px 0 8px 0;color:#666">Data Transfer</h3>
      <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
        <div style="margin-bottom:8px">
          <strong>Generate transfer code</strong>
          <div style="font-size:13px;color:#666">Create a compact code you can copy/paste to another device to restore data.</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" id="generateTransferBtn">Generate Transfer Code</button>
          <button class="secondary" id="copyTransferBtn">Copy</button>
        </div>
        <textarea id="transferCode" rows="4" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:monospace" placeholder="Transfer code will appear here" readonly></textarea>

        <div style="height:12px"></div>

        <div style="margin-top:10px;margin-bottom:6px"><strong>Restore from transfer code</strong></div>
        <textarea id="pasteTransfer" rows="4" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-family:monospace" placeholder="Paste transfer code here to restore"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="restoreTransferBtn">Restore from Code</button>
          <button class="secondary" id="clearTransferBtn">Clear</button>
        </div>
      </div>
    </div>

    <div class="note">Backups saved here are stored in your browser's localStorage under key "backups". Use Download to get a file you can keep externally.</div>

    <div class="list" id="backupsList">
      <h4>Saved Snapshots</h4>
      <div id="snapshotsContainer">
        <!-- snapshots listed here -->
      </div>
    </div>
  </main>
</div>
<script>
  // Theme toggle functionality
  const themeToggle = document.getElementById('themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeToggle.checked = savedTheme === 'dark';
  themeToggle.addEventListener('change', function() {
    const theme = this.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  });
    // Known application localStorage keys to include in backups
    const KNOWN_KEYS = ['activePatients','inactivePatients','todayAppointments','settings','appointments'];

    // helpers
    function getBackupData(){
      const data = {};
      // include known keys; include any other localStorage entries if desired
      KNOWN_KEYS.forEach(k=>{
        try{ data[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ data[k] = localStorage.getItem(k); }
      });
      // also include everything else under their raw string form
      const other = {};
      for(let i=0;i<localStorage.length;i++){
        const key = localStorage.key(i);
        if(!KNOWN_KEYS.includes(key) && key !== 'backups') other[key] = localStorage.getItem(key);
      }
      data._others = other;
      data._meta = { exportedAt: new Date().toISOString(), origin: location.hostname };
      return data;
    }

    function downloadJSON(filename='smartdentistry-backup.json'){
      const data = getBackupData();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function downloadPatientsCSV(filename='patients.csv'){
      // combine active + inactive patients if present
      const act = JSON.parse(localStorage.getItem('activePatients')||'[]');
      const inact = JSON.parse(localStorage.getItem('inactivePatients')||'[]');
      const rows = [['source','name','phone','email','address','registered','lastVisit','lastTreatment']];
      function pushRows(list,src){
        list.forEach(p=>{
          rows.push([src, (p.name||''), (p.phone||''), (p.email||''), (p.address||''), (p.registered||''), (p.lastVisit||''), (p.lastTreatment||'')]);
        });
      }
      pushRows(act,'active');
      pushRows(inact,'inactive');
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function saveSnapshot(){
      const backups = JSON.parse(localStorage.getItem('backups')||'[]');
      const snapshot = { id: Date.now(), meta:{ts:new Date().toISOString()}, data: getBackupData() };
      backups.unshift(snapshot); // newest first
      // limit kept snapshots to 20
      localStorage.setItem('backups', JSON.stringify(backups.slice(0,20)));
      renderSnapshots();
      alert('Snapshot saved to localStorage (backups).');
    }

    function renderSnapshots(){
      const container = document.getElementById('snapshotsContainer');
      const backups = JSON.parse(localStorage.getItem('backups')||'[]');
      container.innerHTML = '';
      if(backups.length === 0){ container.innerHTML = '<div style="padding:8px;color:#666">No snapshots saved.</div>'; return; }
      backups.forEach(b=>{
        const div = document.createElement('div');
        div.className = 'backup-item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${new Date(b.meta.ts).toLocaleString()}</strong><div style="font-size:12px;color:#666">id: ${b.id}</div>`;
        const right = document.createElement('div');
        right.style.display='flex'; right.style.gap='8px';
        const restoreBtn = document.createElement('button');
        restoreBtn.className='secondary'; restoreBtn.textContent='Restore';
        restoreBtn.onclick = ()=>{ if(confirm('Restore this snapshot? This will overwrite current app data in localStorage.')) restoreBackupObject(b.data); };

        const downloadBtn = document.createElement('button');
        downloadBtn.className='btn'; downloadBtn.textContent='Download';
        downloadBtn.onclick = ()=> {
          const blob = new Blob([JSON.stringify(b.data,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
          a.download = `snapshot-${b.id}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
        };

        const delBtn = document.createElement('button');
        delBtn.className='secondary'; delBtn.textContent='Delete';
        delBtn.onclick = ()=> { if(confirm('Delete this snapshot?')) { deleteSnapshot(b.id); } };

        right.appendChild(restoreBtn); right.appendChild(downloadBtn); right.appendChild(delBtn);
        div.appendChild(left); div.appendChild(right);
        container.appendChild(div);
      });
    }

    function deleteSnapshot(id){
      const backups = JSON.parse(localStorage.getItem('backups')||'[]').filter(b=>b.id!==id);
      localStorage.setItem('backups', JSON.stringify(backups));
      renderSnapshots();
    }

    function restoreBackupObject(data){
      // write known keys back
      Object.keys(data).forEach(k=>{
        if(k === '_meta') return;
        try{
          localStorage.setItem(k, JSON.stringify(data[k]));
        }catch(e){
          // fallback if already string
          localStorage.setItem(k, String(data[k]));
        }
      });
      alert('Backup restored into localStorage. Reloading page...');
      location.reload();
    }

    // file import
    document.getElementById('fileInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const parsed = JSON.parse(reader.result);
          if(!confirm('Restore data from uploaded backup? This will overwrite current app data.')) return;
          restoreBackupObject(parsed);
        }catch(err){
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      // reset input so same file can be selected again later
      e.target.value = '';
    });

    // clear app data (dangerous)
    function clearAppData(){
      if(!confirm('Clear application data from localStorage? This cannot be undone (except via backup).')) return;
      // keep backups array (snapshots) unless user chooses to remove
      const preserved = localStorage.getItem('backups');
      localStorage.clear();
      if(preserved) localStorage.setItem('backups', preserved);
      alert('Application data cleared. Reloading page...');
      location.reload();
    }

    // Transfer code helpers (Base64-safe for UTF-8)
    function encodeForTransfer(obj){
      const json = JSON.stringify(obj);
      // encode utf-8 safely
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeFromTransfer(code){
      try{
        const json = decodeURIComponent(escape(atob(code)));
        return JSON.parse(json);
      }catch(e){
        return null;
      }
    }

    document.getElementById('generateTransferBtn').addEventListener('click', ()=>{
      const data = getBackupData();
      const code = encodeForTransfer(data);
      document.getElementById('transferCode').value = code;
    });

    document.getElementById('copyTransferBtn').addEventListener('click', ()=>{
      const val = document.getElementById('transferCode').value;
      if(!val) return alert('No transfer code to copy. Generate one first.');
      navigator.clipboard?.writeText(val).then(()=>alert('Transfer code copied to clipboard.'), ()=>alert('Copy failed. Select and copy manually.'));
    });

    document.getElementById('restoreTransferBtn').addEventListener('click', ()=>{
      const code = document.getElementById('pasteTransfer').value.trim();
      if(!code) return alert('Paste a transfer code first.');
      const parsed = decodeFromTransfer(code);
      if(!parsed) return alert('Invalid transfer code.');
      if(!confirm('Restore data from transfer code? This will overwrite current app data in localStorage.')) return;
      restoreBackupObject(parsed);
    });

    document.getElementById('clearTransferBtn').addEventListener('click', ()=>{ document.getElementById('pasteTransfer').value=''; document.getElementById('transferCode').value=''; });

    // wire buttons
    document.getElementById('downloadJsonBtn').addEventListener('click', ()=>downloadJSON());
    document.getElementById('downloadCsvBtn').addEventListener('click', ()=>downloadPatientsCSV());
    document.getElementById('saveSnapshotBtn').addEventListener('click', saveSnapshot);
    document.getElementById('clearDataBtn').addEventListener('click', clearAppData);
    // generate a preview transfer code if user lands on #transfer
    if(location.hash === '#transfer') setTimeout(()=>document.getElementById('generateTransferBtn').click(), 300);
  </script>
</body>
</html>